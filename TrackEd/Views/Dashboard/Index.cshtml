@{
    ViewData["Title"] = "Dashboard";
    ViewData["href-css"] = "~/css/dashboard.css";
}

@using TrackEd.Services

@functions {
    // Define clinical sites - UPDATED COORDINATES
    private static readonly List<ClinicalSite> ClinicalSites = new List<ClinicalSite>
    {
        new ClinicalSite 
        { 
            Name = "Centennial Hall", 
            Latitude = 36.304306,
            Longitude = -82.364556,
            AcceptableRangeMeters = 100 
        }
    };

    public string LocationResult()
    {
        var coords = LocationUpdateService.GetCoordinates();
        
        if (coords.lat == null || coords.lng == null)
        {
            return "Location not yet available. Waiting for GPS update...";
        }
        
        return $"Longitude: {coords.lng}, Latitude: {coords.lat}\nLast Updated: {coords.lastUpdate:HH:mm:ss}";
    }
}

<!-- Google Font for this page dont touch!! -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Caesar+Dressing&display=swap" rel="stylesheet">

<style>
  .status-active {
    color: green;
    font-weight: bold;
  }
  
  .status-away {
    color: red;
    font-weight: bold;
  }
  
  .status-unknown {
    color: gray;
  }
  
  .settings-box {
    margin: 20px 0;
    padding: 15px;
    background-color: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 8px;
  }

  .table-updating {
    opacity: 0.6;
    transition: opacity 0.3s;
  }
</style>

<script>
  const options = {
    enableHighAccuracy: true,
    timeout: 5000,
    maximumAge: 0,
  };

  // UPDATED CLINICAL SITE COORDINATES
  const CLINICAL_SITE = {
    lat: 36.304306,
    lng: -82.364556,
    name: "Centennial Hall"
  };

  // Mock student data - In production, this would come from your database/API
  const students = [
    { name: "Mason Moore", lat: 36.302, lng: -82.370, site: "Centennial Hall" },
    { name: "Katherine King", lat: 36.303, lng: -82.369, site: "Centennial Hall" },
    { name: "Tyler Stephens", lat: 36.304306, lng: -82.364556, site: "Centennial Hall" },
    { name: "Nick Trahan", lat: 36.332, lng: -82.354, site: "Centennial Hall" },
    { name: "Will Paxton", lat: 36.330, lng: -82.352, site: "Centennial Hall" },
    { name: "Daniel Kefene", lat: 36.304306, lng: -82.364556, site: "Centennial Hall" }
  ];

  // Global variable for adjustable max distance
  let maxDistanceMeters = 100;

  function error(err) {
    console.warn(`ERROR(${err.code}): ${err.message}`);
  }

  function Updatelocation() {
    navigator.geolocation.getCurrentPosition(success, error, options)
  }

  function success(pos) {
    var crd = pos.coords;
    var long = crd.longitude;
    var lat = crd.latitude;

    var payload = {
      longitude: long,
      latitude: lat
    }

    console.log("Sending: ", payload);

    fetch('api/location/SaveCoords', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
      console.log("Response:", data);
      updateMapWithBothMarkers(lat, long);
      updateLocationDisplay(lat, long);
      updateStudentTable(); // NEW: Update the table
    })
    .catch(error => {
      console.error("Error saving coordinates:", error);
      updateMapWithBothMarkers(lat, long);
      updateLocationDisplay(lat, long);
      updateStudentTable(); // NEW: Update the table even on error
    });
  }

  function updateMapWithBothMarkers(studentLat, studentLong) {
    var source = "https://www.google.com/maps/embed/v1/directions?key=AIzaSyBpSX02zBnR-ueioYxcK67SF3DIpyo4hWE" +
                 "&origin=" + CLINICAL_SITE.lat + "," + CLINICAL_SITE.lng +
                 "&destination=" + studentLat + "," + studentLong +
                 "&mode=walking";
    
    document.getElementById("map").src = source;
    console.log("Map updated with both markers:", source);
  }

  function updateLocationDisplay(lat, long) {
    var now = new Date().toLocaleTimeString();
    var distance = calculateDistance(lat, long, CLINICAL_SITE.lat, CLINICAL_SITE.lng);
    
    var status = distance <= maxDistanceMeters ? "✓ AT LOCATION" : "✗ AWAY FROM LOCATION";
    var statusColor = distance <= maxDistanceMeters ? "green" : "red";
    
    var displayText = `Longitude: ${long.toFixed(6)}, Latitude: ${lat.toFixed(6)}\n`;
    displayText += `Distance to ${CLINICAL_SITE.name}: ${distance.toFixed(1)}m\n`;
    displayText += `Acceptable Range: ${maxDistanceMeters}m\n`;
    displayText += `Status: ${status}\n`;
    displayText += `Last Updated: ${now}`;
    
    document.getElementById("locationDisplay").textContent = displayText;
    document.getElementById("locationDisplay").style.color = statusColor;
    document.getElementById("locationDisplay").style.fontWeight = "bold";
  }

  // NEW FUNCTION: Update the student table
  function updateStudentTable() {
    const tbody = document.getElementById("studentTableBody");
    
    // Add updating visual effect
    tbody.classList.add('table-updating');
    
    // Clear existing rows
    tbody.innerHTML = '';
    
    // Rebuild table with current data
    students.forEach(student => {
      const distance = calculateDistance(student.lat, student.lng, CLINICAL_SITE.lat, CLINICAL_SITE.lng);
      const isPresent = distance <= maxDistanceMeters;
      
      const statusText = isPresent 
        ? `✓ At Location (${distance.toFixed(1)}m away)` 
        : `✗ Not at Location (${distance.toFixed(1)}m away)`;
      
      const statusClass = isPresent ? 'status-active' : 'status-away';
      const checkText = isPresent ? '✓ Present' : '✗ Away';
      
      const row = `
        <tr>
          <td>${student.name}</td>
          <td>${student.site}</td>
          <td class="${statusClass}">${statusText}</td>
          <td class="${statusClass}">${checkText}</td>
        </tr>
      `;
      
      tbody.innerHTML += row;
    });
    
    // Remove updating visual effect
    setTimeout(() => {
      tbody.classList.remove('table-updating');
    }, 300);
    
    console.log("Student table updated with current range: " + maxDistanceMeters + "m");
  }

  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000; // Earth's radius in meters
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    
    return R * c;
  }

  function updateSettings() {
    const newDistance = parseInt(document.getElementById('maxDistance').value);
    
    if (isNaN(newDistance) || newDistance < 10 || newDistance > 1000) {
      alert("Please enter a valid distance between 10 and 1000 meters");
      return;
    }
    
    maxDistanceMeters = newDistance;
    document.getElementById('currentRange').textContent = maxDistanceMeters;
    
    console.log("Updated max distance to: " + maxDistanceMeters + "m");
    
    // Re-check current location with new distance
    Updatelocation();
    
    // Also update the table immediately
    updateStudentTable();
    
    // Visual feedback
    const btn = event.target;
    btn.textContent = "Applied!";
    btn.style.backgroundColor = "#28a745";
    setTimeout(() => {
      btn.textContent = "Apply";
      btn.style.backgroundColor = "";
    }, 1500);
  }

  window.onload = function() {
    // Show hospital marker initially
    var initialSource = "https://www.google.com/maps/embed/v1/place?key=AIzaSyBpSX02zBnR-ueioYxcK67SF3DIpyo4hWE" +
                       "&q=" + CLINICAL_SITE.lat + "," + CLINICAL_SITE.lng +
                       "&zoom=15";
    document.getElementById("map").src = initialSource;
    
    // Initialize the table
    updateStudentTable();
    
    // Then get student location
    Updatelocation();
    
    // Auto-update every 60 seconds
    setInterval(function() {
      console.log("Auto-updating location and table...");
      Updatelocation();
    }, 60000);
  };
</script>

<h1 class="caesar-dressing-regular">Dashboard</h1>

<div class="dash-boxes">
    <div class="dash-box">
      <h2>Student Locations</h2>
      <p>Track real-time locations of nursing students during their clinical placements.</p>
    </div>
    <div class="dash-box">
      <h2>Program Analytics</h2>
      <p>View key statistics and reports on student engagement, attendance, and site activity.</p>
    </div>
    <div class="dash-box">
      <h2>Faculty Overview</h2>
      <p>Manage and assign instructors, oversee supervision schedules, and monitor clinical hours.</p>
    </div>
</div>

<!-- Distance Settings Control -->
<div class="settings-box">
  <h3 style="margin-top: 0;">⚙️ Range Settings</h3>
  <label for="maxDistance" style="font-weight: bold;">Acceptable Distance Range (meters):</label>
  <input type="number" id="maxDistance" value="100" min="10" max="1000" step="10" 
         style="padding: 8px; font-size: 16px; width: 100px; margin: 0 10px;">
  <button onclick="updateSettings()" style="padding: 8px 20px; font-size: 16px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px;">Apply</button>
  <p style="font-size: 14px; color: #666; margin-top: 10px; margin-bottom: 0;">
    Current Range: <strong><span id="currentRange">100</span>m</strong>
    <br>
    <em>💡 Tip: 50m = strict, 100m = normal, 200m+ = loose</em>
  </p>
</div>

<h3>Student Status <span style="font-size: 14px; color: #666;">(Auto-updates every 60 seconds)</span></h3>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Location</th>
      <th>Status</th>
      <th>Distance Check</th>
    </tr>
  </thead>
  <tbody id="studentTableBody">
    <!-- Table rows will be dynamically generated by JavaScript -->
  </tbody>
</table>

<h3>Live Tracking Map</h3>
<p style="color: #666; font-size: 14px;">
  📍 <strong>Point A</strong>: Centennial Hall | 
  📍 <strong>Point B</strong>: Current Student Location
</p>
<iframe src="" width="500px" height="500px" id="map" style="border: 2px solid #ccc;"></iframe>

<input type="button" value="Refresh Location" onclick="Updatelocation();" style="margin-top: 10px; padding: 10px 20px; font-size: 16px; cursor: pointer;">
<pre id="locationDisplay" style="font-size: 16px; margin-top: 10px;">@LocationResult()</pre>


<!-- ========================= -->


<!-- TASK MANAGEMENT SECTION -->


<!-- ========================= -->





<section class="task-section">


    <h2>Nursing Program Tasks</h2>


    <p>View all ongoing clinical assignments and academic tasks in table or calendar format.</p>





    <div class="view-toggle">


        <button id="tableViewBtn" class="active">Table View</button>


        <button id="calendarViewBtn">Calendar View</button>


    </div>





    <!-- ===== TABLE VIEW ===== -->


    <div id="tableView" class="view">


        <table class="task-table">


            <thead>


                <tr>


                    <th>Task ID</th>


                    <th>Task Name</th>


                    <th>Assigned To</th>


                    <th>Status</th>


                    <th>Due Date</th>


                </tr>


            </thead>


            <tbody>


                <tr><td>T-001</td><td>Update Student Clinical Rotations</td><td>Tyler Stephens</td><td><span class="status in-progress">In Progress</span></td><td>Nov 21, 2025</td></tr>


                <tr><td>T-002</td><td>Submit Weekly Clinical Evaluations</td><td>Katherine King</td><td><span class="status pending">Pending</span></td><td>Nov 22, 2025</td></tr>


                <tr><td>T-003</td><td>Upload Patient Care Plan</td><td>Daniel Kefene</td><td><span class="status completed">Completed</span></td><td>Nov 17, 2025</td></tr>


                <tr><td>T-004</td><td>Review HIPAA Compliance Module</td><td>Mason Moore</td><td><span class="status in-progress">In Progress</span></td><td>Nov 23, 2025</td></tr>


                <tr><td>T-005</td><td>Attend Simulation Lab</td><td>Will Paxton</td><td><span class="status review">Scheduled</span></td><td>Nov 25, 2025</td></tr>


            </tbody>


        </table>


    </div>





    <!-- ===== CALENDAR VIEW ===== -->


    <div id="calendarView" class="view hidden">


        <section class="calendar-section">


            <h3>Interactive Clinical Task Calendar</h3>


            <div id="calendar" class="calendar"></div>





            <!-- Modal to Add Tasks -->


            <div id="taskModal" class="modal hidden">


                <div class="modal-content">


                    <h3>Add Clinical Task</h3>


                    <input type="text" id="taskTitle" placeholder="Task Title (e.g., Submit Care Plan)">


                    <input type="text" id="taskAssigned" placeholder="Assigned To (e.g., Mason Moore)">


                    <button id="saveTask">Save Task</button>


                    <button id="cancelTask" class="cancel">Cancel</button>


                </div>


            </div>


        </section>


    </div>


</section>





<script>


    // ========== TABLE ↔ CALENDAR TOGGLE ==========


    const tableViewBtn = document.getElementById("tableViewBtn");


    const calendarViewBtn = document.getElementById("calendarViewBtn");


    const tableView = document.getElementById("tableView");


    const calendarView = document.getElementById("calendarView");





    tableViewBtn.addEventListener("click", () => {


        tableView.classList.remove("hidden");


        calendarView.classList.add("hidden");


        tableViewBtn.classList.add("active");


        calendarViewBtn.classList.remove("active");


    });





    calendarViewBtn.addEventListener("click", () => {


        tableView.classList.add("hidden");


        calendarView.classList.remove("hidden");


        calendarViewBtn.classList.add("active");


        tableViewBtn.classList.remove("active");


    });





    // ========== INTERACTIVE CALENDAR ==========


    const calendar = document.getElementById('calendar');


    const modal = document.getElementById('taskModal');


    const saveBtn = document.getElementById('saveTask');


    const cancelBtn = document.getElementById('cancelTask');


    const taskTitleInput = document.getElementById('taskTitle');


    const taskAssignedInput = document.getElementById('taskAssigned');





    const daysInMonth = 30; // demo month


    let selectedDay = null;


    const tasks = {};





    function buildCalendar() {


        calendar.innerHTML = `


            <div class="day header">Sun</div>


            <div class="day header">Mon</div>


            <div class="day header">Tue</div>


            <div class="day header">Wed</div>


            <div class="day header">Thu</div>


            <div class="day header">Fri</div>


            <div class="day header">Sat</div>


        `;


        for (let i = 1; i <= daysInMonth; i++) {


            const dayDiv = document.createElement('div');


            dayDiv.classList.add('day');


            dayDiv.innerHTML = `<span class="date">${i}</span><div class="task-list"></div>`;


            if (i === new Date().getDate()) dayDiv.classList.add('today'); // highlight today


            dayDiv.addEventListener('click', () => openModal(i));


            calendar.appendChild(dayDiv);


        }


        renderTasks();


    }





    function renderTasks() {


        document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');


        for (let day in tasks) {


            const dayCell = calendar.querySelector(`.day:nth-child(${parseInt(day) + 7})`);


            const list = dayCell.querySelector('.task-list');


            tasks[day].forEach(t => {


                const p = document.createElement('p');


                p.textContent = `${t.title} (${t.assigned})`;


                list.appendChild(p);


            });


        }


    }





    function openModal(day) {


        selectedDay = day;


        modal.classList.remove('hidden');


        taskTitleInput.value = '';


        taskAssignedInput.value = '';


    }




    saveBtn.addEventListener('click', () => {


        const title = taskTitleInput.value.trim();


        const assigned = taskAssignedInput.value.trim();


        if (!title) return alert('Please enter a task title.');


        if (!tasks[selectedDay]) tasks[selectedDay] = [];


        tasks[selectedDay].push({ title, assigned });


        modal.classList.add('hidden');


        renderTasks();


    });





    cancelBtn.addEventListener('click', () => modal.classList.add('hidden'));


    buildCalendar();


</script>