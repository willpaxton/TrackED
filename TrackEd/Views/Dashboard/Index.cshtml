@{
    ViewData["Title"] = "Dashboard";
    ViewData["href-css"] = "~/css/dashboard.css";
}

@using TrackEd.Services

@functions {
    // Simulate student geolocation API
    public async Task<string> GetStudentGeoLocationsAsync()
    {
        await Task.Delay(500); // simulate async API call

        // Mock geolocation data for students
        var locations = new[]
        {
            new { Name = "Daniel Kefene", Latitude = 36.332, Longitude = -82.354 },
            new { Name = "Mason Moore", Latitude = 36.335, Longitude = -82.358 },
            new { Name = "Katherine King", Latitude = 36.330, Longitude = -82.352 }
        };

        string result = "Student Geolocations:\n";
        foreach (var loc in locations)
        {
            result += $"{loc.Name}: Latitude={loc.Latitude}, Longitude={loc.Longitude}\n";
        }

        return result;
    }

    public string LocationResult()
    {
        var coords = LocationUpdateService.GetCoordinates();
        
        if (coords.lat == null || coords.lng == null)
        {
            return "Location not yet available. Waiting for GPS update...";
        }
        
        return $"Longitude: {coords.lng}, Latitude: {coords.lat}\nLast Updated: {coords.lastUpdate:HH:mm:ss}";
    }
  
}


<!-- Google Font for this page dont touch!! -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Caesar+Dressing&display=swap" rel="stylesheet">


<script>
  const options = {
    enableHighAccuracy: true,
    timeout: 5000,
    maximumAge: 0,
  };

  function error(err) {
    console.warn(`ERROR(${err.code}): ${err.message}`);
  }

  function Updatelocation() {
    navigator.geolocation.getCurrentPosition(success, error, options)
  }

  function success(pos) {
    var crd = pos.coords;
    var long = crd.longitude;
    var lat = crd.latitude;

    var payload = {
      longitude: long,
      latitude: lat
    }

    console.log("Sending: ", payload);

    fetch('api/location/SaveCoords', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
      console.log("Response:", data);
      // Update map with marker
      updateMapWithMarker(lat, long);
      // Update location display
      updateLocationDisplay(lat, long);
    })
    .catch(error => {
      console.error("Error saving coordinates:", error);
      // Fallback to manual URL construction with marker
      updateMapWithMarker(lat, long);
      updateLocationDisplay(lat, long);
    });
  }

  function updateMapWithMarker(lat, long) {
    // Using 'place' mode instead of 'view' mode to show a marker
    var source = "https://www.google.com/maps/embed/v1/place?key=AIzaSyBpSX02zBnR-ueioYxcK67SF3DIpyo4hWE&q=" + lat + "," + long + "&zoom=18";
    document.getElementById("map").src = source;
    console.log("Map updated with marker:", source);
  }

  function updateLocationDisplay(lat, long) {
    var now = new Date().toLocaleTimeString();
    var displayText = `Longitude: ${long}, Latitude: ${lat}\nLast Updated: ${now}`;
    document.getElementById("locationDisplay").textContent = displayText;
  }

  // Update location immediately on page load
  window.onload = function() {
    Updatelocation();
    
    // Set up automatic updates every 60 seconds (1 minute)
    setInterval(function() {
      console.log("Auto-updating location...");
      Updatelocation();
    }, 60000); // 60000 milliseconds = 1 minute
  };
</script>


<h1 class="caesar-dressing-regular">Dashboard</h1>


<div class="dash-boxes">
    <div class="dash-box">
      <h2>Student Locations</h2>
      <p>Track real-time locations of nursing students during their clinical placements.</p>
    </div>
    <div class="dash-box">
      <h2>Program Analytics</h2>
      <p>View key statistics and reports on student engagement, attendance, and site activity.</p>
    </div>
    <div class="dash-box">
      <h2>Faculty Overview</h2>
      <p>Manage and assign instructors, oversee supervision schedules, and monitor clinical hours.</p>
    </div>
  </div>

  
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Location</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Mason Moore</td>
      <td>Johnson City Medical Center</td>
      <td>Active</td>
    </tr>
    <tr>
      <td>Katherine King</td>
      <td>Johnson City Medical Center</td>
      <td>Active</td>
    </tr>
    <tr>
      <td>Tyler Stephens</td>
      <td>Johnson City Medical Center</td>
      <td>Active</td>
    </tr>
    <tr>
      <td>Nick Trahan</td>
      <td>Johnson City Medical Center</td>
      <td>Active</td>
    </tr>
    <tr>
      <td>Will Paxton</td>
      <td>Johnson City Medical Center</td>
      <td>Active</td>
    </tr>
    <tr>
      <td>Daniel Kefene</td>
      <td>Johnson City Medical Center</td>
      <td>Active</td>
    </tr>
  </tbody>
</table>

<iframe src="https://www.google.com/maps/embed/v1/view?key=AIzaSyBpSX02zBnR-ueioYxcK67SF3DIpyo4hWE&center=36.302360811187214,-82.36984874754702&zoom=15" width="500px" height="500px" id="map"></iframe>

<input type="button" value="Refresh" onclick="Updatelocation();">
<pre id="locationDisplay">@LocationResult()</pre>

<!-- <div class="geo-test-result">
    <h2>Mock Student Geolocations</h2>
    <pre>@await GetStudentGeoLocationsAsync()</pre>
</div> -->